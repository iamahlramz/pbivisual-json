<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PBI Preview — Power BI Report Prototyping Tool</title>
  <style>
    :root {
      --bg: #F3F2F1;
      --canvas-bg: #FFFFFF;
      --text-primary: #252423;
      --text-secondary: #605E5C;
      --text-light: #B3B0AD;
      --grid-line: #E6E6E6;
      --border: #C8C6C4;
      --accent: #118DFF;
      --sidebar-bg: #2D2D2D;
      --sidebar-text: #E0E0E0;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      width: 280px;
      min-width: 280px;
      background: var(--sidebar-bg);
      color: var(--sidebar-text);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      border-right: 1px solid #444;
    }

    .sidebar h2 {
      font-size: 14px;
      font-weight: 600;
      padding: 16px 16px 8px;
      color: #FFFFFF;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      border-bottom: 1px solid #444;
    }

    .sidebar-section {
      padding: 12px 16px;
      border-bottom: 1px solid #3A3A3A;
    }

    .sidebar-section h3 {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: #999;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }

    .theme-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .theme-btn {
      padding: 6px 8px;
      border: 2px solid transparent;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      font-family: 'Segoe UI', sans-serif;
      text-align: left;
      transition: all 0.15s;
      background: #3A3A3A;
      color: #E0E0E0;
    }

    .theme-btn:hover { border-color: #666; }
    .theme-btn.active { border-color: var(--accent); background: #444; }

    .theme-btn .color-dots {
      display: flex;
      gap: 3px;
      margin-top: 4px;
    }

    .theme-btn .color-dots span {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }

    .visual-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .visual-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-family: 'Segoe UI', sans-serif;
      text-align: left;
      background: transparent;
      color: #CCC;
      transition: all 0.15s;
    }

    .visual-btn:hover { background: #3A3A3A; color: #FFF; }
    .visual-btn .icon { font-size: 16px; width: 20px; text-align: center; }

    /* ===== MAIN AREA ===== */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      background: #FFFFFF;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .toolbar .logo {
      font-weight: 700;
      font-size: 16px;
      color: var(--accent);
      margin-right: 8px;
    }

    .toolbar button {
      padding: 5px 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: #FFF;
      cursor: pointer;
      font-size: 12px;
      font-family: 'Segoe UI', sans-serif;
      color: var(--text-primary);
      transition: all 0.15s;
    }

    .toolbar button:hover { background: #F3F2F1; }
    .toolbar button.primary { background: var(--accent); color: #FFF; border-color: var(--accent); }
    .toolbar button.primary:hover { background: #0078D4; }

    .toolbar .spacer { flex: 1; }

    .toolbar .page-tabs {
      display: flex;
      gap: 4px;
    }

    .toolbar .page-tab {
      padding: 4px 12px;
      border: 1px solid transparent;
      border-radius: 4px;
      background: transparent;
      cursor: pointer;
      font-size: 12px;
      font-family: 'Segoe UI', sans-serif;
      color: var(--text-secondary);
    }

    .toolbar .page-tab.active {
      background: #E8E8E8;
      color: var(--text-primary);
      font-weight: 600;
    }

    /* ===== CANVAS ===== */
    .canvas-wrapper {
      flex: 1;
      overflow: auto;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 24px;
    }

    .canvas {
      width: 1280px;
      min-height: 720px;
      background: var(--canvas-bg);
      box-shadow: 0 2px 12px rgba(0,0,0,0.12);
      border-radius: 2px;
      position: relative;
      overflow: hidden;
    }

    .canvas-page-bg {
      width: 100%;
      height: 100%;
      min-height: 720px;
      padding: 16px;
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      grid-auto-rows: minmax(40px, auto);
      gap: 12px;
      align-content: start;
    }

    /* ===== VISUAL TILES ===== */
    .visual-tile {
      background: #FFFFFF;
      border: 1px solid var(--grid-line);
      border-radius: 4px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      position: relative;
      cursor: move;
      transition: box-shadow 0.15s;
      overflow: hidden;
    }

    .visual-tile:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }

    .visual-tile.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(17,141,255,0.25);
    }

    .visual-tile .v-header {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-family: 'DIN', 'Segoe UI', sans-serif;
    }

    .visual-tile .v-body {
      flex: 1;
      display: flex;
      align-items: flex-end;
      gap: 4px;
      min-height: 80px;
    }

    .visual-tile .v-remove {
      position: absolute;
      top: 4px;
      right: 6px;
      background: none;
      border: none;
      cursor: pointer;
      color: #CCC;
      font-size: 14px;
      line-height: 1;
      padding: 2px;
    }

    .visual-tile .v-remove:hover { color: #D64554; }

    /* ===== CHART RENDERERS ===== */
    .bar { border-radius: 2px; transition: height 0.3s; }
    .bar-h { border-radius: 2px; transition: width 0.3s; height: 16px; margin-bottom: 4px; }

    .line-chart-svg { width: 100%; height: 100%; }

    .pie-container { display: flex; align-items: center; justify-content: center; width: 100%; }

    .card-value {
      font-size: 36px;
      font-weight: 700;
      font-family: 'DIN', 'Segoe UI', sans-serif;
      line-height: 1.1;
    }

    .card-label {
      font-size: 11px;
      color: var(--text-light);
      margin-top: 4px;
    }

    .table-mini { width: 100%; border-collapse: collapse; font-size: 10px; }
    .table-mini th {
      text-align: left;
      padding: 4px 6px;
      border-bottom: 2px solid var(--grid-line);
      font-weight: 600;
      color: var(--text-primary);
    }
    .table-mini td {
      padding: 4px 6px;
      border-bottom: 1px solid var(--grid-line);
      color: var(--text-secondary);
    }

    .gauge-container { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; }
    .gauge-value { font-size: 28px; font-weight: 700; font-family: 'DIN', 'Segoe UI', sans-serif; }
    .gauge-label { font-size: 10px; color: var(--text-light); }

    .slicer-items { display: flex; flex-direction: column; gap: 4px; width: 100%; }
    .slicer-item {
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 3px;
      cursor: pointer;
      color: var(--text-secondary);
    }
    .slicer-item:hover { background: #F3F2F1; }
    .slicer-item.sel { background: rgba(17,141,255,0.1); color: var(--accent); font-weight: 600; }

    .kpi-container { text-align: center; width: 100%; }
    .kpi-value { font-size: 32px; font-weight: 700; font-family: 'DIN', sans-serif; }
    .kpi-trend { font-size: 11px; margin-top: 4px; }
    .kpi-trend.up { color: #1AAB40; }
    .kpi-trend.down { color: #D64554; }

    .map-placeholder {
      width: 100%;
      height: 100%;
      min-height: 120px;
      background: linear-gradient(135deg, #E8F4FD 0%, #D6EAF8 50%, #E8F8E8 100%);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-light);
      font-size: 12px;
    }

    /* ===== JSON PANEL ===== */
    .json-panel {
      position: fixed;
      right: 0;
      top: 0;
      width: 420px;
      height: 100vh;
      background: #1E1E1E;
      color: #D4D4D4;
      transform: translateX(100%);
      transition: transform 0.25s;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .json-panel.open { transform: translateX(0); }

    .json-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid #333;
      flex-shrink: 0;
    }

    .json-panel-header h3 { font-size: 13px; color: #FFF; }

    .json-panel-header button {
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 18px;
    }

    .json-panel pre {
      flex: 1;
      padding: 16px;
      overflow: auto;
      font-family: 'Cascadia Code', 'Fira Code', Consolas, monospace;
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .json-panel .copy-btn {
      margin: 12px 16px;
      padding: 8px 16px;
      background: var(--accent);
      color: #FFF;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-family: 'Segoe UI', sans-serif;
      flex-shrink: 0;
    }

    .json-panel .copy-btn:hover { background: #0078D4; }

    /* ===== TOAST ===== */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: #252423;
      color: #FFF;
      padding: 8px 20px;
      border-radius: 6px;
      font-size: 13px;
      transition: transform 0.3s;
      z-index: 200;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* ===== CUSTOM COLOR SECTION ===== */
    .color-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .color-row label {
      font-size: 11px;
      color: #AAA;
      width: 55px;
      flex-shrink: 0;
    }

    .color-row input[type="color"] {
      width: 28px;
      height: 22px;
      border: 1px solid #555;
      border-radius: 3px;
      cursor: pointer;
      background: none;
      padding: 0;
    }

    .color-row .hex {
      font-size: 10px;
      color: #777;
      font-family: Consolas, monospace;
    }

    /* Grid placement helpers */
    .span-3 { grid-column: span 3; }
    .span-4 { grid-column: span 4; }
    .span-6 { grid-column: span 6; }
    .span-8 { grid-column: span 8; }
    .span-12 { grid-column: span 12; }
    .row-2 { grid-row: span 2; }
    .row-3 { grid-row: span 3; }
    .row-4 { grid-row: span 4; }
  </style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <h2>PBI Preview</h2>

  <!-- Theme Selection -->
  <div class="sidebar-section">
    <h3>Theme</h3>
    <div class="theme-grid" id="themeGrid"></div>
  </div>

  <!-- Custom Colors -->
  <div class="sidebar-section">
    <h3>Custom Data Colors</h3>
    <div id="customColors"></div>
  </div>

  <!-- Visual Palette -->
  <div class="sidebar-section">
    <h3>Add Visual</h3>
    <div class="visual-list" id="visualList"></div>
  </div>
</div>

<!-- MAIN -->
<div class="main">
  <div class="toolbar">
    <span class="logo">PBI Preview</span>
    <div class="page-tabs">
      <button class="page-tab active">Page 1</button>
    </div>
    <span class="spacer"></span>
    <button onclick="exportJSON()" class="primary">Export Theme JSON</button>
    <button onclick="clearCanvas()">Clear Canvas</button>
  </div>
  <div class="canvas-wrapper">
    <div class="canvas">
      <div class="canvas-page-bg" id="canvas"></div>
    </div>
  </div>
</div>

<!-- JSON PANEL -->
<div class="json-panel" id="jsonPanel">
  <div class="json-panel-header">
    <h3>Theme JSON Output</h3>
    <button onclick="toggleJSON()">&times;</button>
  </div>
  <pre id="jsonOutput"></pre>
  <button class="copy-btn" onclick="copyJSON()">Copy to Clipboard</button>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ===== THEMES =====
const THEMES = {
  'Default': {
    dataColors: ['#118DFF', '#12239E', '#E66C37', '#6B007B', '#E044A7', '#744EC2', '#D9B300', '#D64550'],
    background: '#FFFFFF', foreground: '#252423', tableAccent: '#118DFF'
  },
  'Executive': {
    dataColors: ['#4B5A6E', '#7A8B99', '#4E8542', '#C04E3E', '#E8A838', '#7C5C92', '#3A7CA5', '#D4804E'],
    background: '#FFFFFF', foreground: '#2D3436', tableAccent: '#4B5A6E'
  },
  'Innovate': {
    dataColors: ['#00B7C3', '#6554C0', '#FF5630', '#36B37E', '#FFAB00', '#8777D9', '#00A3BF', '#FF8B00'],
    background: '#FFFFFF', foreground: '#172B4D', tableAccent: '#00B7C3'
  },
  'Bloom': {
    dataColors: ['#F472B6', '#A78BFA', '#60A5FA', '#34D399', '#FBBF24', '#FB923C', '#E879F9', '#818CF8'],
    background: '#FFFFFF', foreground: '#1F2937', tableAccent: '#F472B6'
  },
  'Sunset': {
    dataColors: ['#FF6B6B', '#FFA07A', '#FFD93D', '#6BCB77', '#4D96FF', '#9B59B6', '#E74C3C', '#F39C12'],
    background: '#FFFFFF', foreground: '#2C3E50', tableAccent: '#FF6B6B'
  },
  'Ocean': {
    dataColors: ['#006994', '#00A8CC', '#45B7D1', '#96E6A1', '#DDB892', '#BC6C25', '#0077B6', '#023E8A'],
    background: '#FFFFFF', foreground: '#023047', tableAccent: '#006994'
  },
  'Forest': {
    dataColors: ['#2D6A4F', '#40916C', '#52B788', '#74C69D', '#95D5B2', '#B7E4C7', '#1B4332', '#081C15'],
    background: '#FFFFFF', foreground: '#1B4332', tableAccent: '#2D6A4F'
  },
  'Dark Mode': {
    dataColors: ['#58A6FF', '#F78166', '#3FB950', '#D2A8FF', '#79C0FF', '#FFA657', '#FF7B72', '#56D364'],
    background: '#0D1117', foreground: '#C9D1D9', tableAccent: '#58A6FF'
  },
  'Corporate Blue': {
    dataColors: ['#003F5C', '#2F4B7C', '#665191', '#A05195', '#D45087', '#F95D6A', '#FF7C43', '#FFA600'],
    background: '#FFFFFF', foreground: '#003F5C', tableAccent: '#003F5C'
  },
  'Warm Earth': {
    dataColors: ['#8B4513', '#CD853F', '#D2691E', '#DEB887', '#A0522D', '#F4A460', '#BC8F8F', '#DAA520'],
    background: '#FFFDF7', foreground: '#3E2723', tableAccent: '#8B4513'
  },
  'Neon Pop': {
    dataColors: ['#FF006E', '#8338EC', '#3A86FF', '#06D6A0', '#FFD166', '#EF476F', '#118AB2', '#073B4C'],
    background: '#FFFFFF', foreground: '#073B4C', tableAccent: '#FF006E'
  },
  'Pastel': {
    dataColors: ['#A8D8EA', '#AA96DA', '#FCBAD3', '#FFFFD2', '#B5EAD7', '#C7CEEA', '#FFB7B2', '#FFDAC1'],
    background: '#FFFFFF', foreground: '#4A4A4A', tableAccent: '#A8D8EA'
  },
  'Monochrome': {
    dataColors: ['#1A1A1A', '#333333', '#4D4D4D', '#666666', '#808080', '#999999', '#B3B3B3', '#CCCCCC'],
    background: '#FFFFFF', foreground: '#1A1A1A', tableAccent: '#333333'
  },
  'Colorblind Safe': {
    dataColors: ['#1170AA', '#FC7D0B', '#A3ACB9', '#57606C', '#5FA2CE', '#C85200', '#7B848F', '#E1E5E8'],
    background: '#FFFFFF', foreground: '#333333', tableAccent: '#1170AA'
  }
};

let currentTheme = 'Default';
let currentColors = [...THEMES.Default.dataColors];
let visuals = [];
let selectedVisual = null;

// ===== VISUAL DEFINITIONS =====
const VISUAL_TYPES = [
  { id: 'clusteredColumn', name: 'Clustered Column', icon: '|||', span: 'span-6 row-3' },
  { id: 'clusteredBar', name: 'Clustered Bar', icon: '???', span: 'span-6 row-3' },
  { id: 'line', name: 'Line Chart', icon: '???', span: 'span-6 row-3' },
  { id: 'area', name: 'Area Chart', icon: '???', span: 'span-6 row-3' },
  { id: 'pie', name: 'Pie Chart', icon: '???', span: 'span-4 row-3' },
  { id: 'donut', name: 'Donut Chart', icon: '???', span: 'span-4 row-3' },
  { id: 'card', name: 'Card', icon: '#', span: 'span-3 row-2' },
  { id: 'multiRowCard', name: 'Multi-row Card', icon: '???', span: 'span-4 row-3' },
  { id: 'table', name: 'Table', icon: '???', span: 'span-6 row-4' },
  { id: 'matrix', name: 'Matrix', icon: '???', span: 'span-6 row-4' },
  { id: 'gauge', name: 'Gauge', icon: '???', span: 'span-3 row-3' },
  { id: 'kpi', name: 'KPI', icon: '???', span: 'span-3 row-2' },
  { id: 'slicer', name: 'Slicer', icon: '???', span: 'span-3 row-3' },
  { id: 'waterfall', name: 'Waterfall', icon: '???', span: 'span-6 row-3' },
  { id: 'treemap', name: 'Treemap', icon: '???', span: 'span-4 row-3' },
  { id: 'funnel', name: 'Funnel', icon: '???', span: 'span-4 row-3' },
  { id: 'scatter', name: 'Scatter', icon: '???', span: 'span-6 row-3' },
  { id: 'map', name: 'Map', icon: '???', span: 'span-6 row-3' },
  { id: 'ribbon', name: 'Ribbon', icon: '???', span: 'span-6 row-3' },
];

// ===== INIT =====
function init() {
  renderThemeGrid();
  renderCustomColors();
  renderVisualList();
  addDefaultVisuals();
}

function renderThemeGrid() {
  const grid = document.getElementById('themeGrid');
  grid.innerHTML = '';
  Object.entries(THEMES).forEach(([name, theme]) => {
    const btn = document.createElement('button');
    btn.className = 'theme-btn' + (name === currentTheme ? ' active' : '');
    btn.innerHTML = `${name}<div class="color-dots">${theme.dataColors.slice(0, 5).map(c => `<span style="background:${c}"></span>`).join('')}</div>`;
    btn.onclick = () => applyTheme(name);
    grid.appendChild(btn);
  });
}

function renderCustomColors() {
  const container = document.getElementById('customColors');
  container.innerHTML = '';
  currentColors.forEach((color, i) => {
    const row = document.createElement('div');
    row.className = 'color-row';
    row.innerHTML = `
      <label>Color ${i + 1}</label>
      <input type="color" value="${color}" onchange="updateColor(${i}, this.value)">
      <span class="hex">${color}</span>
    `;
    container.appendChild(row);
  });
}

function renderVisualList() {
  const list = document.getElementById('visualList');
  list.innerHTML = '';
  VISUAL_TYPES.forEach(v => {
    const btn = document.createElement('button');
    btn.className = 'visual-btn';
    btn.innerHTML = `<span class="icon">${v.icon}</span> ${v.name}`;
    btn.onclick = () => addVisual(v.id);
    list.appendChild(btn);
  });
}

function addDefaultVisuals() {
  addVisual('card');
  addVisual('card');
  addVisual('card');
  addVisual('card');
  addVisual('clusteredColumn');
  addVisual('line');
  addVisual('donut');
  addVisual('table');
  addVisual('slicer');
}

// ===== THEME APPLICATION =====
function applyTheme(name) {
  currentTheme = name;
  currentColors = [...THEMES[name].dataColors];

  const theme = THEMES[name];
  document.documentElement.style.setProperty('--canvas-bg', theme.background);
  document.documentElement.style.setProperty('--text-primary', theme.foreground);
  document.documentElement.style.setProperty('--accent', theme.dataColors[0]);

  renderThemeGrid();
  renderCustomColors();
  renderCanvas();
}

function updateColor(index, color) {
  currentColors[index] = color;
  renderCustomColors();
  renderCanvas();
}

// ===== ADD VISUAL =====
function addVisual(typeId) {
  const def = VISUAL_TYPES.find(v => v.id === typeId);
  visuals.push({
    id: Date.now() + Math.random(),
    type: typeId,
    span: def.span,
    title: def.name
  });
  renderCanvas();
}

function removeVisual(id) {
  visuals = visuals.filter(v => v.id !== id);
  selectedVisual = null;
  renderCanvas();
}

function selectVisual(id) {
  selectedVisual = id;
  renderCanvas();
}

function clearCanvas() {
  visuals = [];
  selectedVisual = null;
  renderCanvas();
}

// ===== CANVAS RENDER =====
function renderCanvas() {
  const canvas = document.getElementById('canvas');
  canvas.style.background = THEMES[currentTheme].background;
  canvas.innerHTML = '';

  visuals.forEach(v => {
    const tile = document.createElement('div');
    tile.className = `visual-tile ${v.span}` + (selectedVisual === v.id ? ' selected' : '');
    tile.onclick = (e) => { e.stopPropagation(); selectVisual(v.id); };

    const header = `<div class="v-header">${v.title}</div>`;
    const remove = `<button class="v-remove" onclick="event.stopPropagation(); removeVisual(${v.id})">&times;</button>`;
    const body = renderVisualBody(v);

    tile.innerHTML = header + remove + `<div class="v-body">${body}</div>`;
    canvas.appendChild(tile);
  });
}

function renderVisualBody(visual) {
  const c = currentColors;
  switch (visual.type) {
    case 'clusteredColumn':
      return renderColumnChart(c);
    case 'clusteredBar':
      return renderBarChart(c);
    case 'line':
      return renderLineChart(c);
    case 'area':
      return renderAreaChart(c);
    case 'pie':
      return renderPieChart(c);
    case 'donut':
      return renderDonutChart(c);
    case 'card':
      return renderCard(c);
    case 'multiRowCard':
      return renderMultiRowCard(c);
    case 'table':
      return renderTable(c);
    case 'matrix':
      return renderMatrix(c);
    case 'gauge':
      return renderGauge(c);
    case 'kpi':
      return renderKPI(c);
    case 'slicer':
      return renderSlicer(c);
    case 'waterfall':
      return renderWaterfall(c);
    case 'treemap':
      return renderTreemap(c);
    case 'funnel':
      return renderFunnel(c);
    case 'scatter':
      return renderScatter(c);
    case 'map':
      return `<div class="map-placeholder">Map Visual</div>`;
    case 'ribbon':
      return renderColumnChart(c);
    default:
      return '<div style="color:#999;font-size:11px;">Visual placeholder</div>';
  }
}

function renderColumnChart(c) {
  const vals = [65, 80, 45, 90, 55, 70];
  return vals.map((v, i) =>
    `<div class="bar" style="width:${100/vals.length - 2}%;height:${v}%;background:${c[i % c.length]}"></div>`
  ).join('');
}

function renderBarChart(c) {
  const vals = [75, 60, 85, 45, 70];
  return `<div style="width:100%;display:flex;flex-direction:column;gap:4px;">${vals.map((v, i) =>
    `<div class="bar-h" style="width:${v}%;background:${c[i % c.length]}"></div>`
  ).join('')}</div>`;
}

function renderLineChart(c) {
  const points1 = [[0,70],[20,40],[40,60],[60,30],[80,50],[100,20]];
  const points2 = [[0,80],[20,60],[40,75],[60,50],[80,65],[100,40]];
  const toPath = (pts) => pts.map((p,i) => `${i===0?'M':'L'}${p[0]} ${p[1]}`).join(' ');
  return `<svg class="line-chart-svg" viewBox="0 0 100 100" preserveAspectRatio="none">
    <path d="${toPath(points1)}" fill="none" stroke="${c[0]}" stroke-width="2.5"/>
    <path d="${toPath(points2)}" fill="none" stroke="${c[1]}" stroke-width="2.5"/>
  </svg>`;
}

function renderAreaChart(c) {
  const points = [[0,70],[20,40],[40,60],[60,30],[80,50],[100,25]];
  const path = points.map((p,i) => `${i===0?'M':'L'}${p[0]} ${p[1]}`).join(' ');
  return `<svg class="line-chart-svg" viewBox="0 0 100 100" preserveAspectRatio="none">
    <path d="${path} L100 100 L0 100 Z" fill="${c[0]}33" stroke="${c[0]}" stroke-width="2"/>
  </svg>`;
}

function renderPieChart(c) {
  const vals = [35, 25, 20, 12, 8];
  let cum = 0;
  const paths = vals.map((v, i) => {
    const start = cum / 100 * 360;
    cum += v;
    const end = cum / 100 * 360;
    const x1 = 50 + 40 * Math.cos((start - 90) * Math.PI / 180);
    const y1 = 50 + 40 * Math.sin((start - 90) * Math.PI / 180);
    const x2 = 50 + 40 * Math.cos((end - 90) * Math.PI / 180);
    const y2 = 50 + 40 * Math.sin((end - 90) * Math.PI / 180);
    const large = v > 50 ? 1 : 0;
    return `<path d="M50 50 L${x1} ${y1} A40 40 0 ${large} 1 ${x2} ${y2} Z" fill="${c[i % c.length]}"/>`;
  });
  return `<div class="pie-container"><svg viewBox="0 0 100 100" width="120" height="120">${paths.join('')}</svg></div>`;
}

function renderDonutChart(c) {
  const vals = [35, 25, 20, 12, 8];
  let cum = 0;
  const r = 40, ir = 24;
  const paths = vals.map((v, i) => {
    const s = cum / 100 * 360;
    cum += v;
    const e = cum / 100 * 360;
    const sa = (s - 90) * Math.PI / 180, ea = (e - 90) * Math.PI / 180;
    const x1 = 50 + r * Math.cos(sa), y1 = 50 + r * Math.sin(sa);
    const x2 = 50 + r * Math.cos(ea), y2 = 50 + r * Math.sin(ea);
    const x3 = 50 + ir * Math.cos(ea), y3 = 50 + ir * Math.sin(ea);
    const x4 = 50 + ir * Math.cos(sa), y4 = 50 + ir * Math.sin(sa);
    const large = v > 50 ? 1 : 0;
    return `<path d="M${x1} ${y1} A${r} ${r} 0 ${large} 1 ${x2} ${y2} L${x3} ${y3} A${ir} ${ir} 0 ${large} 0 ${x4} ${y4} Z" fill="${c[i % c.length]}"/>`;
  });
  return `<div class="pie-container"><svg viewBox="0 0 100 100" width="120" height="120">${paths.join('')}</svg></div>`;
}

function renderCard(c) {
  const vals = ['$12.4K', '$8.7K', '1,247', '86.3%'];
  const labels = ['Revenue', 'Profit', 'Customers', 'Satisfaction'];
  const idx = Math.floor(Math.random() * vals.length);
  return `<div style="width:100%"><div class="card-value" style="color:${c[0]}">${vals[idx]}</div><div class="card-label">${labels[idx]}</div></div>`;
}

function renderMultiRowCard(c) {
  const rows = [
    { label: 'Revenue', value: '$12.4K' },
    { label: 'Profit', value: '$8.7K' },
    { label: 'Orders', value: '1,247' }
  ];
  return `<div style="width:100%">${rows.map(r =>
    `<div style="padding:6px 0;border-bottom:1px solid var(--grid-line)"><div style="font-size:14px;font-weight:700;color:${c[0]}">${r.value}</div><div style="font-size:10px;color:var(--text-light)">${r.label}</div></div>`
  ).join('')}</div>`;
}

function renderTable(c) {
  return `<table class="table-mini">
    <tr><th>Product</th><th>Revenue</th><th>Units</th><th>Margin</th></tr>
    <tr><td>Widget A</td><td style="color:${c[0]}">$4,200</td><td>120</td><td>32%</td></tr>
    <tr><td>Widget B</td><td style="color:${c[0]}">$3,800</td><td>95</td><td>28%</td></tr>
    <tr><td>Widget C</td><td style="color:${c[0]}">$2,900</td><td>78</td><td>35%</td></tr>
    <tr><td>Widget D</td><td style="color:${c[0]}">$1,500</td><td>42</td><td>41%</td></tr>
    <tr><td style="font-weight:600">Total</td><td style="font-weight:600;color:${c[0]}">$12,400</td><td style="font-weight:600">335</td><td style="font-weight:600">33%</td></tr>
  </table>`;
}

function renderMatrix(c) {
  return `<table class="table-mini">
    <tr><th></th><th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th></tr>
    <tr><td style="font-weight:600">North</td><td style="color:${c[0]}">$2.1K</td><td style="color:${c[0]}">$2.4K</td><td style="color:${c[0]}">$2.8K</td><td style="color:${c[0]}">$3.1K</td></tr>
    <tr><td style="font-weight:600">South</td><td style="color:${c[1]}">$1.8K</td><td style="color:${c[1]}">$1.6K</td><td style="color:${c[1]}">$2.1K</td><td style="color:${c[1]}">$2.3K</td></tr>
    <tr><td style="font-weight:600">East</td><td style="color:${c[2]}">$3.2K</td><td style="color:${c[2]}">$3.5K</td><td style="color:${c[2]}">$3.1K</td><td style="color:${c[2]}">$3.8K</td></tr>
  </table>`;
}

function renderGauge(c) {
  const pct = 72;
  const angle = (pct / 100) * 180;
  const r = 38;
  const endX = 50 + r * Math.cos((180 - angle) * Math.PI / 180);
  const endY = 50 - r * Math.sin((180 - angle) * Math.PI / 180);
  return `<div class="gauge-container">
    <svg viewBox="0 0 100 60" width="140" height="84">
      <path d="M12 50 A38 38 0 0 1 88 50" fill="none" stroke="#E6E6E6" stroke-width="7" stroke-linecap="round"/>
      <path d="M12 50 A38 38 0 0 1 ${endX} ${endY}" fill="none" stroke="${c[0]}" stroke-width="7" stroke-linecap="round"/>
    </svg>
    <div class="gauge-value" style="color:${c[0]}">${pct}%</div>
    <div class="gauge-label">of target</div>
  </div>`;
}

function renderKPI(c) {
  return `<div class="kpi-container">
    <div class="kpi-value" style="color:${THEMES[currentTheme].foreground}">$12.4K</div>
    <div class="kpi-trend up">&#9650; 12.3% vs last period</div>
  </div>`;
}

function renderSlicer(c) {
  const items = ['All', 'North', 'South', 'East', 'West'];
  return `<div class="slicer-items">${items.map((item, i) =>
    `<div class="slicer-item${i === 0 ? ' sel' : ''}" style="${i === 0 ? 'color:' + c[0] : ''}">${item}</div>`
  ).join('')}</div>`;
}

function renderWaterfall(c) {
  const bars = [
    { h: 60, y: 40, color: c[0] },
    { h: 20, y: 20, color: '#1AAB40' },
    { h: 15, y: 25, color: '#D64554' },
    { h: 25, y: 15, color: '#1AAB40' },
    { h: 10, y: 30, color: '#D64554' },
    { h: 60, y: 40, color: c[0] }
  ];
  return bars.map((b, i) =>
    `<div class="bar" style="width:${100/bars.length - 2}%;height:${b.h}%;margin-top:${b.y}%;background:${b.color}"></div>`
  ).join('');
}

function renderTreemap(c) {
  return `<div style="width:100%;height:100%;display:grid;grid-template-columns:60% 40%;grid-template-rows:55% 45%;gap:2px;">
    <div style="background:${c[0]};border-radius:2px;display:flex;align-items:center;justify-content:center;color:#FFF;font-size:11px;font-weight:600">Category A</div>
    <div style="background:${c[1]};border-radius:2px;display:flex;align-items:center;justify-content:center;color:#FFF;font-size:10px">Cat B</div>
    <div style="background:${c[2]};border-radius:2px;display:flex;align-items:center;justify-content:center;color:#FFF;font-size:10px">Cat C</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px;">
      <div style="background:${c[3]};border-radius:2px;display:flex;align-items:center;justify-content:center;color:#FFF;font-size:9px">D</div>
      <div style="background:${c[4]};border-radius:2px;display:flex;align-items:center;justify-content:center;color:#FFF;font-size:9px">E</div>
    </div>
  </div>`;
}

function renderFunnel(c) {
  const vals = [100, 75, 50, 30, 15];
  return `<div style="width:100%;display:flex;flex-direction:column;align-items:center;gap:2px;">${vals.map((v, i) =>
    `<div style="width:${v}%;height:20px;background:${c[i % c.length]};border-radius:2px;display:flex;align-items:center;justify-content:center;color:#FFF;font-size:9px">${v}%</div>`
  ).join('')}</div>`;
}

function renderScatter(c) {
  const dots = [[20,30],[35,55],[50,40],[65,70],[30,65],[75,45],[45,20],[60,80],[25,50],[80,60]];
  return `<svg class="line-chart-svg" viewBox="0 0 100 100">
    <line x1="10" y1="90" x2="95" y2="90" stroke="#E6E6E6" stroke-width="0.5"/>
    <line x1="10" y1="10" x2="10" y2="90" stroke="#E6E6E6" stroke-width="0.5"/>
    ${dots.map((d, i) => `<circle cx="${d[0]}" cy="${100 - d[1]}" r="3.5" fill="${c[i % c.length]}80" stroke="${c[i % c.length]}" stroke-width="0.5"/>`).join('')}
  </svg>`;
}

// ===== EXPORT =====
function exportJSON() {
  const theme = {
    name: `${currentTheme} — PBI Preview Theme`,
    dataColors: [...currentColors],
    background: THEMES[currentTheme].background,
    foreground: THEMES[currentTheme].foreground,
    tableAccent: currentColors[0],
    good: '#1AAB40',
    neutral: '#D9B300',
    bad: '#D64554',
    maximum: currentColors[0],
    center: '#D9B300',
    minimum: '#DEEFFF',
    null: '#FF7F48'
  };

  document.getElementById('jsonOutput').textContent = JSON.stringify(theme, null, 2);
  document.getElementById('jsonPanel').classList.add('open');
}

function toggleJSON() {
  document.getElementById('jsonPanel').classList.toggle('open');
}

function copyJSON() {
  const text = document.getElementById('jsonOutput').textContent;
  navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard!'));
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

// ===== CLICK OUTSIDE =====
document.addEventListener('click', (e) => {
  if (!e.target.closest('.visual-tile')) {
    selectedVisual = null;
    renderCanvas();
  }
});

// ===== GO =====
init();
</script>
</body>
</html>
